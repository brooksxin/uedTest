<!DOCTYPE html>
<html>
<head>
<title>创建外呼营销任务step2_选择商品</title>
<#include "../../tpl/res_css.tpl" />
</head>
<body>
<div class="formItem">
    <div class="titleArea bd-bottom fn-clear">
        <a href="javascript:history.go(-1);" class="ui-getBackJ fn-left"></a><h2 class="ui-textIndentStyle fn-left">创建新项目</h2>
    </div>


    <div class="flowSteps_six">
        <!--第二步样式改为current_2-->
        <ul class="current_2 fn-clear">
            <li class="FirstStep">
                <a href="javascript:;">基本信息</a>
            </li>
            <li class="SecondStep">
                <a href="javascript:;">选择商品</a>
            </li>
             <li class="ThirdStep">
                <a href="javascript:;">添加问卷</a>
            </li>
            <li class="FourStep">
                <a href="javascript:;">目标客户</a>
            </li>
            <li class="FiveStep">
                <a href="javascript:;">执行团队</a>
            </li>
        </ul>
    </div>

	<div class="record-search-cate" style="margin-top:30px;">
	<form class="record-search-form record-search-min record-search-form-border" id="J_formSearch" name="J_formSearch" >
      <table class="search_table" width="100%">
          <tbody>
          
              <tr>
                  <td width="80"><label class="description">商品编号</label></td>
                  <td>
                      <input name="mcdsUnitId" class="inputWidth inputText" type="text" maxlength="255" value=""/>
                  </td>
                  <td width="80"><label class="description">商品名称</label>
                   
                  </td>
                  <td>
                      <input name="mcdsUnitNm" class="inputWidth inputText" type="text" maxlength="255" value=""/>
                      <input name="mcdsUnitTypeCd" class="inputWidth inputText" type="text" maxlength="255" value="02" style="display:none"/>
                  </td>
                 <!--  <td width="80"><label class="description">商家</label></td>
                  <td>
                   <select class="inputSelect" style="width:100px;">
                      <option>全部</option>
                   </select>
                  </td>
                  <td><div class="table_select"><input type="checkbox" /></div></td>
                  <td>
                       是否促销
                  </td>   -->
                  <td width="100">
				       <div class="normalBtnArea w82">
                            <a class="searchBtn" href="javascript:;" id="query_btn"  ><i></i>查询</a>
                        </div>
				  </td>
              </tr>
             
          </tbody>
      </table>
       </form>
</div>

<div class="tablewidth mg_t_10" style="margin-top:15px;">
                <table class="ui-record-table table_radius table-bordered table-striped"  >
                    <thead>
                        <tr>
                            <th width="25"></th>
                            <th width="80">商品编号</th>
                            <th>商品名称</th>
                            <th width="80">价格（元）</th>
                            <th width="80">库存</th>
                        </tr>
                     </thead>
                     <tbody id="J_tabletpl">
                        
                    </tbody>
                </table>
</div>
          
              <!--翻页及功能按钮区域开始-->
    <DIV class="amount-bottom">
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="gridBottom">
          <tr>
            <td>
                <DIV class="fn-clear action-other  action-other-show ">
                        <DIV id=Pagination class="page pagination fn-right"> </DIV>
                        <DIV class="fn-right fn-pt5 fn-pr10"></DIV>
                </DIV></td>
          </tr>
        </table>
    </DIV>	

    </div>

<div class="tablewidth fn-mt10 attributionValue fn-hide" id="Prom">
    <table class="ui-record-table table-bordered table-striped">
        <thead>
            <tr>
                <th style="text-align:left;padding-left:15px" id="promName"></th>
         	</tr>
        </thead>
        <tr>
            <td>
            	<div class="fn-clear">
						<div class="ml-15">可选促销</div>
						<div id="J_promtable">
							
						</div>
					</div>
				</td>
        </tr>
    </table>
    </div>





    <div class="formBtnArea bd-top">
        <table width="100%">
            <tr>
                <td>
                    <div class="normalBtnArea">
                        <a class="normalBtn BGgray largeBtn" href="#" id="Return">上一步</a>
                        <a class="normalBtn BGblue largeBtn" href="javascript:;" id="J_button_add">下一步</a>
                        <a class="normalBtn BGgray largeBtn" href="javascript:;" id="Save">保存</a>
                    </div>
                </td>
                <td>
                    <div class="normalBtnArea fn-right">
                        <a href="#" class="formLink" id="CanCelCreate"><span>取消创建</span></a>
                    </div>
                </td>
            </tr>
        </table>
    </div>
	<script id="T_tabletpl" type="text/x-handlebars-template">
    {{#if beans}}
    {{#each beans}}
       <tr>
                            <td><div class="table_select">
                             <input name="myRadio" data-unitid="{{MCDS_UNIT_ID}}" data-name="{{MCDS_UNIT_NM}}" type="radio" onclick="selectProd(this)"/><input class="dataListNo" value="{{MCDS_UNIT_ID}}" type="hidden"/>
                            <input class="dataListNM" value="{{MCDS_UNIT_NM}}" type="hidden"/></div></td>
                            <td>{{MCDS_UNIT_ID}}</td>
                            <td><div class="gridRowBtn"><a class="item-text" href="javascript:;">{{MCDS_UNIT_NM}}</a></div></td>
                            <td>{{UPRC}}</td>
                            <td>{{SKU_QTY}}</td>
                        </tr>
    {{/each}}
    {{else}}
        <tr class="noData">
            <td colspan="6" class="fn-center">对不起，暂无数据</td>
        </tr>
    {{/if}}
</script>

<script id="T_Promtabletpl" type="text/x-handlebars-template">
{{#if beans}}
    {{#each beans}}
	<label for="{{PMT_ID}}">
	   <div class="xborder_m fn-left mt-10 mb-10 ml-15">
		 <div class="pb-10">
		    	<input name="checkbox" type="radio" class="selectAll" id="{{PMT_ID}}">选择
		 </div>
         <input name="PMT_ID" type="hidden" id="PMT_ID" value="{{PMT_ID}}">
		 <div class="textyc_sl" title="{{PMT_DESC}}">{{PMT_DESC}}</div>
         <p class="gray_text">优惠机型：{{MCDS_UNIT_NM}}</p>
		 <p class="gray_text">{{preferentialWay}}</p>
	 </div>
</label>
 {{/each}}
    {{else}}
        <tr class="noData">
            <td colspan="6" class="fn-center">对不起，暂无数据</td>
        </tr>
 {{/if}}
  </script>

<#include "../../tpl/res_js.tpl" />
 
<script type="text/javascript">
srvMap.add('selectSingleProd','market/selectSingleProd.json','front/sh/prod!execute?uid=p006');
srvMap.add('selectSingleProm','selectSingleProm.json','front/sh/market!index?uid=zzh003');//加载促销
srvMap.add('bindingMarketCmpgnWithMcds','selectSingleProd.json','front/sh/market!index?uid=mwq002');
srvMap.add('query' , 'query.json','front/sh/market!index?uid=mwq003');//根据活动ID查询所有绑定的商品
srvMap.add('insert' , 'query.json','front/sh/market!index?uid=mwq002');//绑定营销活动和商品
srvMap.add('delete' , 'query.json','front/sh/market!index?uid=mwq005');//解绑活动和商品的关系
var id=Util.browser.getParameter("id");
var cmd={"CMPGN_ID":id};
var _pid;
var PMT_ID;
//页面加载完成时执行
$(function () {
  	 
    //获取初始化数据
    execPage();

    //点击查询重新获取数据
     $('#query_btn').bind('click',function(){
        execPage();
    }); 
    //点击表格选中行
     $("#J_tabletpl").bind("click",function(event){
        var _target=event.target;
        var _currentLine=$(_target).parent("tr");
        _currentLine.addClass("active");
        _currentLine.siblings().removeClass("active");
        _currentLine.find("input[type=radio]").attr("checked",true);
        _currentLine.find("td").css({"background":"#E0EDFA"});
        _currentLine.siblings().find("td").css({"background":""});
    });


    //获取选中行的商品pid
    $("#J_button_add").bind("click",function(event){
        //若没有数据，禁止a标签的点击行为
        _pid=$("#J_tabletpl tr.active input.dataListNo").val();
        if(typeof _pid ==="undefined"){
            Util.dialog.tips("请选择一个商品!")
        }else{
        	//PMT_ID=$("#PMT_ID").val();
        	PMT_ID=$(".selectAll:checked").attr("id");
        	 var cmds={
       			  "CMPGN_ID":id,
       			  "MCDS_ID":_pid,
       			  "PMT_ID":PMT_ID
       	    };
         Util.ajax.postJson(srvMap.get('query'),cmd,function(json){
                var beans=json.beans;
              if(beans.size!=0){                
                Util.ajax.postJson(srvMap.get('delete'),cmd,function(json){
              	  if(json.returnCode==0){                   	  
              		  Util.ajax.postJson(srvMap.get('insert'),cmds,function(json){
              			window.location.href="addGoods.html?id="+id+"&goodId="+_pid;
              		  });
              	  }
              	  
                });
            
         
                }else{
              	  
      		       Util.ajax.postJson(srvMap.get('insert'),cmds,function(json){
      			      if(json.returnCode=="0"){
      				     window.location.href="addGoods.html?id="+id+"&goodId="+_pid;
      			      }
      		  
      		       });
            
                }
         });
   
        }
        
        
    }); 
    
    
  //获取选中行的商品pid
    $("#Save").bind("click",function(event){
        //若没有数据，禁止a标签的点击行为
        _pid=$("#J_tabletpl tr.active input.dataListNo").val();
        if(typeof _pid ==="undefined"){
            Util.dialog.tips("请选择一个商品!")
        }else{
        	//PMT_ID=$("#PMT_ID").val();
        	PMT_ID=$(".selectAll:checked").attr("id");
        	 var cmds={
       			  "CMPGN_ID":id,
       			  "MCDS_ID":_pid,
       			  "PMT_ID":PMT_ID
       	    };
         Util.ajax.postJson(srvMap.get('query'),cmd,function(json){
                var beans=json.beans;
              if(beans!=null&&beans!=""){                
                Util.ajax.postJson(srvMap.get('delete'),cmd,function(json){
              	  if(json.returnCode==0){                   	  
              		  Util.ajax.postJson(srvMap.get('insert'),cmds,function(json){
              			window.location.href="draftList.html";
              		  });
              	  }
              	  
                });
                }else{
      		       Util.ajax.postJson(srvMap.get('insert'),cmds,function(json){
      			      if(json.returnCode=="0"){
      			    	window.location.href="draftList.html";
      			      }
      		       });
            
                }
         });
   
        }
        
        
    }); 
    
  
  $("#Return").bind("click",function(){
	  window.location.href="newCampgnNew.html?id="+id; 
  });
});
function fun_cancel(){
	window.location.href='draftList.html';
}

function pageback(){
	    var MCDS_ID="";
	    var MCDS_NM="";
	    var PMT_ID="";
        Util.ajax.postJsonSync(srvMap.get('query'),cmd,function(json,status){
            if(status){
                if(json.beans.length != "0"){
                    MCDS_ID = json.beans[0].MCDS_ID;
                    PMT_ID=json.beans[0].PMT_ID;
                     $("#J_tabletpl tr").each(function(index,item){
                        
                        var _self = $(this).find("td:eq(0) input[type='radio']")
                        var unitid = _self.data("unitid");
                        
                        if(unitid == MCDS_ID){  
                            _self.attr("checked",true);
                            _self.parent().parent().parent().addClass("active").siblings().removeClass("active");
                            MCDS_NM==$("#J_tabletpl tr.active input.dataListNM").val();
                        }
                    });
                }
                
            }
        });
        if(MCDS_ID!=""){
        	 var paramProm={"MCDS_ID":MCDS_ID};
        	 //alert(PMT_ID);
             //查询促销
             Util.ajax.postJsonSync(srvMap.get('selectSingleProm'),paramProm,function(json,status){
                 if(status){
                	// console.log(json);
                     if(json.beans.length != "0"){
                    	 $("#Prom").show();
                    	 $("#promName").html("已选择："+MCDS_NM);
                     	Util.ajax.loadTemp('#J_promtable', $('#T_Promtabletpl'), json);
                     	$('#J_promtable').find("label").each(function(i,obj){
                     		var _self=$(obj).find('input[type="radio"]');
                     		var _id=_self.attr('id');
                     		if(PMT_ID == _id){
                     			_self.attr("checked",true);
                     			_self.parent().parent().addClass("active");
                     		}else{
                     			_self.attr("checked",false);
                     		}
                     	})
                     	/*  $("#J_promtable div").each(function(index,item){
                            
                            var _self = $(this).find("td:eq(0) input[type='checkbox']")
                            var unitid = _self.data("unitid");
                            
                            if(unitid == PMT_ID){  
                                _self.attr("checked",true);
                                _self.parent().parent().parent().addClass("active").siblings().removeClass("active");
                                MCDS_NM==$("#J_tabletpl tr.active input.dataListNM").val();
                            }
                        });
                     	 */
                     	
                     }
                     
                 }
             });
        }
       
        
}

function selectProd(obj){
    $(obj).parent().parent().parent().addClass("active").siblings().removeClass("active");
    var MCDS_ID=$("#J_tabletpl tr.active input.dataListNo").val();
    var MCDS_NM=$("#J_tabletpl tr.active input.dataListNM").val();
    var paramProm={"MCDS_ID":MCDS_ID};
    //查询促销
    Util.ajax.postJsonSync(srvMap.get('selectSingleProm'),paramProm,function(json,status){
        if(status){
        	//console.log(json);
            if(json.beans.length != "0"){
            	$("#Prom").show();
            	 $("#promName").html("已选择："+MCDS_NM);
            	 //console.log(json);
            	Util.ajax.loadTemp('#J_promtable', $('#T_Promtabletpl'), json);
            }else{
            	$("#Prom").hide();
            }
            
        }
    });
}

function execPage(){
    var _G_params = {
        url : srvMap.get('selectSingleProd'),
        searchformId :"J_formSearch",
        items_per_page : 10,   //每页数 @param : limit
        page_index : 0, //当前页 @param : start
        pagination : "Pagination", //分页标识id
        tabletpl : "T_tabletpl", //表格模板
        tablewrap :"J_tabletpl", //表格容器
        pageCallback: pageback
    };
    var str= $("#"+_G_params.searchformId).serialize();
    Util.pagination(_G_params.page_index ,true,_G_params,str);
}

$(function(){
	  $("#CanCelCreate").bind("click",function(){
		 var elem= $('<div class="fn-hide"><div class="warn-wrapper"><div class="warn-logo"></div><div class="warn-text">是否取消创建该项目？</div></div></div>');
	        var paramsdiv = {
	          top:top,
	          content: elem,
	          width: "300px",
	          height: "140px",
	          modal: true,
	          okVal:'取消创建',
	          okCallback:function(){
	                $(obj).hide().siblings().hide();
	                window.location.href="../market/campgnList.html";
	          },
	          cancelVal:'返回继续创建',
	          cancelCallback:function(){}
	        }
	        Util.dialog.openDiv(paramsdiv);
	  });
});
</script>
</body>
</html>




